@page "/objectives"
@page "/"
@using GamifyMe.Shared.Dtos
@using GamifyMe.UI.Shared.Helpers @* INDISPENSABLE POUR LES ICÔNES *@
@inject HttpClient Http
@using System.Net.Http.Json
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Mes Objectifs</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4 mb-16">
    
    <MudText Typo="Typo.h4" Class="mb-6" Color="Color.Primary">Objectifs Disponibles</MudText>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="ma-auto d-block" />
    }
    else if (objectives == null || !objectives.Any())
    {
        <MudAlert Severity="Severity.Info">Aucun objectif disponible pour le moment.</MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var obj in objectives)
            {
                <MudItem xs="12" sm="6">
                    <MudCard Elevation="3" Class="h-100 d-flex flex-column">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled">
                                    @* UTILISATION DE L'HELPER ICI *@
                                    <MudIcon Icon="@IconLibrary.GetIcon(obj.IconName)" />
                                </MudAvatar>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@obj.Title</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @if (obj.EventDate.HasValue)
                                    {
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-1" />
                                            @* 'g' est un format standard : 15/10/2025 14:30 *@
                                            <span>@obj.EventDate.Value.ToString("g")</span>
                                        </div>
                                    }

                                    @if (obj.EndDate.HasValue)
                                    {
                                        <div class="d-flex align-center mt-1">
                                            <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Small" Class="mr-1" />
                                            <span>Expire : @obj.EndDate.Value.ToString("g")</span>
                                        </div>
                                    }
                                    else if (!obj.EventDate.HasValue)
                                    {
                                        <span>Permanent</span>
                                    }
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @if (obj.IsUnique)
                                {
                                    <MudTooltip Text="Objectif Unique">
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" />
                                    </MudTooltip>
                                }
                            </CardHeaderActions>
                        </MudCardHeader>
                        
                        <MudCardContent Class="flex-grow-1">
                            <MudText Typo="Typo.body2" Class="mb-2">@obj.Description</MudText>
                            
                            @if (!string.IsNullOrEmpty(obj.Location))
                            {
                                <div class="d-flex align-center mt-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" Color="Color.Default" Class="mr-1"/>
                                    <MudText Typo="Typo.caption">@obj.Location</MudText>
                                </div>
                            }
                        </MudCardContent>

                        <MudCardActions Class="d-flex justify-end pa-3 bg-gray-light">
                            <MudChip T="string" Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Size="Size.Small">@obj.XpReward XP</MudChip>
                            <MudChip T="string" Icon="@Icons.Material.Filled.MonetizationOn" Color="Color.Info" Size="Size.Small">@obj.DocPointsReward Pts</MudChip>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>



@code {
    private List<ObjectiveDto> objectives = new();
    private bool isLoading = true;

    // ON SUPPRIME OnInitializedAsync
    // protected override async Task OnInitializedAsync()
    // {
    //     await LoadObjectives();
    // }

    // ON REMPLACE PAR CECI :
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // On attend que l'authentification soit bien en place
            // (Petite astuce : GetAuthenticationStateAsync force la vérification du token)
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

            if (authState.User.Identity != null && authState.User.Identity.IsAuthenticated)
            {
                await LoadObjectives();
            }
            else
            {
                // Si pas connecté, on arrête le chargement (ou on redirige)
                isLoading = false;
            }

            StateHasChanged(); // Indispensable pour rafraîchir l'affichage après le chargement
        }
    }

    private async Task LoadObjectives()
    {
        isLoading = true;
        StateHasChanged(); // Affiche le spinner

        try
        {
            objectives = await Http.GetFromJsonAsync<List<ObjectiveDto>>("api/objectives/active") ?? new List<ObjectiveDto>();
        }
        catch (Exception ex)
        {
            // On peut logger l'erreur ou juste laisser la liste vide si 401
            Console.WriteLine($"Erreur chargement objectifs : {ex.Message}");
        }
        finally
        {
            isLoading = false;
            // Pas besoin de StateHasChanged ici car il est appelé dans OnAfterRenderAsync juste après
        }
    }
}