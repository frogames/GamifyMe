@page "/confirm-email"
@attribute [AllowAnonymous]

@using System.Net.Http.Json
@using GamifyMe.UI.Shared.Services

@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>Validation de l'email</PageTitle>

<div class="login-container">
    <div class="login-form" style="text-align: center;">

        @if (string.IsNullOrEmpty(message))
        {
            <h1 style="color: var(--text-muted-color);">Validation en cours...</h1>
            <p>Veuillez patienter pendant que nous vérifions votre lien.</p>
        }
        else
        {
            <h1 style="@(isSuccess ? "color: var(--success-color);" : "color: var(--danger-color);")">
                @headerMessage
            </h1>
            <p style="margin-top: 1.5rem;">@message</p>

            @if (isSuccess)
            {
                <button class="submit-btn" @onclick="GoToLogin">Aller à la page de connexion</button>
            }
        }

    </div>
</div>

@code {
    private string? message;
    private string headerMessage = "Erreur";
    private bool isSuccess = false;
    private int countdown = 3;
    private System.Threading.Timer? redirectTimer;

    [SupplyParameterFromQuery(Name = "userId")]
    public string? UserId { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            isSuccess = false;
            headerMessage = "Lien invalide";
            message = "Le lien de confirmation est incomplet. Veuillez vérifier le lien dans votre email.";
            return;
        }

        try
        {
            var requestUrl = $"api/Users/confirm-email?token={Uri.EscapeDataString(Token)}";
            var response = await Http.GetAsync(requestUrl);

            if (response.IsSuccessStatusCode)
            {
                isSuccess = true;
                headerMessage = "Compte validé !";
                message = $"Votre email a été confirmé avec succès. Redirection vers la connexion dans {countdown} secondes...";
                
                redirectTimer = new System.Threading.Timer(async _ =>
                {
                    countdown--;
                    if (countdown <= 0)
                    {
                        redirectTimer?.Dispose();
                        await InvokeAsync(() => Navigation.NavigateTo("/login"));
                    }
                    else
                    {
                        message = $"Votre email a été confirmé avec succès. Redirection vers la connexion dans {countdown} secondes...";
                        await InvokeAsync(StateHasChanged);
                    }
                }, null, 1000, 1000);
            }
            else
            {
                isSuccess = false;
                headerMessage = "Échec de la validation";
                var errorContent = await response.Content.ReadAsStringAsync();
                message = $"Erreur : {errorContent}";
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            headerMessage = "Erreur de connexion";
            message = $"Impossible de contacter le serveur d'authentification : {ex.Message}";
        }

        StateHasChanged();
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        redirectTimer?.Dispose();
    }
}