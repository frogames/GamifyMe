@page "/register"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]

@using GamifyMe.Shared.Dtos
@using GamifyMe.UI.Shared.Services
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject TokenStorageService TokenService

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center mud-width-full" Style="height: 100vh;">
    <MudPaper Elevation="3" Class="pa-8" Width="100%">
        <MudText Typo="Typo.h4" GutterBottom="true" Align="Align.Center">Créer un compte</MudText>

        <EditForm Model="@registerModel" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />

            <MudTextField Label="Nom d'utilisateur"
                          @bind-Value="registerModel.Username"
                          For="@(() => registerModel.Username)"
                          Variant="Variant.Outlined"
                          Class="mb-4" />

            <MudTextField Label="Email"
                          @bind-Value="registerModel.Email"
                          For="@(() => registerModel.Email)"
                          Variant="Variant.Outlined"
                          Class="mb-4" />

            <MudTextField Label="Mot de passe"
                          @bind-Value="registerModel.Password"
                          For="@(() => registerModel.Password)"
                          InputType="InputType.Password"
                          Variant="Variant.Outlined"
                          Class="mb-6" />

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       Disabled="@_processing">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Création...</MudText>
                }
                else
                {
                    <MudText>S'inscrire</MudText>
                }
            </MudButton>
        </EditForm>

        <MudText Align="Align.Center" Class="mt-4">
            Déjà un compte ? <MudLink Href="login">Se connecter</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private RegisterDto registerModel = new RegisterDto();
    private bool _processing = false;

    protected override void OnInitialized()
    {
        // SOLUTION SIMPLE (SANS WebUtilities)
        // On lit l'URL nous-mêmes avec du C# de base
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            // uri.Query ressemble à "?establishmentId=333..."
            var query = uri.Query;

            if (!string.IsNullOrEmpty(query) && query.Contains("establishmentId="))
            {
                // On coupe la chaîne pour récupérer ce qui est après le "="
                var parts = query.Split("establishmentId=");
                if (parts.Length > 1)
                {
                    // On prend la partie droite et on s'arrête au prochain "&" s'il y en a un
                    var idString = parts[1].Split('&')[0];

                    if (Guid.TryParse(idString, out var guid))
                    {
                        registerModel.EstablishmentId = guid;
                        Console.WriteLine($"[Register] ID valide trouvé : {guid}");
                    }
                }
            }
        }
        catch
        {
            // Si ça échoue, ce n'est pas grave, l'API Backend (version Sauvetage) gérera l'ID vide.
        }
    }

    private async Task OnValidSubmit()
    {
        _processing = true;
        try
        {
            var response = await Http.PostAsJsonAsync("api/users/register", registerModel);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Compte créé avec succès !", Severity.Success);
                Navigation.NavigateTo("login");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Erreur : {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur technique : {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
}