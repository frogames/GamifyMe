@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div id="@_scannerId"></div>

@code {
    [Parameter] public EventCallback<string> OnScanSuccess { get; set; }

    private string _scannerId = "qr-scanner-" + Guid.NewGuid().ToString();
    private DotNetObjectReference<QrCodeScanner>? _objRef;

    protected override void OnInitialized()
    {
        _objRef = DotNetObjectReference.Create(this);
    }

    public async Task StartAsync()
    {
        await JSRuntime.InvokeVoidAsync("window.qrScanner.start", _scannerId, _objRef);
    }

    public async Task StopAsync()
    {
        await JSRuntime.InvokeVoidAsync("window.qrScanner.stop", _scannerId);
    }

    [JSInvokable("HandleScanResult")]
    public async Task HandleScanResult(string decodedText)
    {
        if (OnScanSuccess.HasDelegate)
        {
            await OnScanSuccess.InvokeAsync(decodedText);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await StopAsync();
            _objRef?.Dispose();
        }
        catch { /* Ignorer */ }
    }
}