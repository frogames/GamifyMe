@using GamifyMe.Shared.Dtos
@using System.Net.Http.Json
@inject HttpClient Http

@if (IsOpen)
{
    <div class="modal-backdrop show" style="background-color: rgba(0,0,0,0.8); position: fixed; top:0; left:0; width:100%; height:100%; z-index:1040;"></div>
    <div class="modal show" tabindex="-1" style="display: block; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); z-index:1050;">
        <div class="modal-dialog modal-dialog-centered" style="max-width:90vw; width:500px;"> <div class="modal-content" style="border-radius:15px; overflow: hidden; border: none; box-shadow:010px30px rgba(0,0,0,0.5);">
        
        <div class="modal-header" style="background-color: #594AE2; color: white; display:flex; justify-content:center; align-items:center; position:relative;">
            <h5 class="modal-title" style="margin:0; text-align:center; width:100%;">Valider : <strong>@objectiveToScan?.Title</strong></h5>
            <button type="button" class="btn-close btn-close-white" @onclick="Close" style="position:absolute; right:10px; top:10px;"></button>
        </div>
        
        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding:20px; background-color: #f8f9fa;">

                    @if (!string.IsNullOrEmpty(scanMessage))
                    {
                        <div class="alert @(isScanError ? "alert-danger" : "alert-success")" style="width:100%; text-align: center; margin-bottom:15px;">
                            @scanMessage
                        </div>
                    }

                    @if (_isScannerComponentActive)
                    {
                        <p style="margin-bottom:10px; font-weight:500;">Scannez le QR code du joueur :</p>
                        
                        <div style="width:100%; max-width:350px; aspect-ratio: 1 / 1; border:4px solid #594AE2; border-radius:12px; overflow: hidden; position: relative; background: black;">
                            <QrCodeScanner @ref="qrScannerRef" OnScanSuccess="HandleScanResult" />
                        </div>
                        
                        <button type="button" class="btn btn-danger mt-3" @onclick="Close" style="width:100%; max-width:350px;">
                            Arrêter la caméra
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {

    [Parameter] public EventCallback OnScanSuccessRefresh { get; set; }

    private bool IsOpen = false;
    private ObjectiveDto? objectiveToScan;
    private string? scanMessage;
    private bool isScanError = false;
    private bool _isScannerComponentActive = true;
    private QrCodeScanner? qrScannerRef;

    public async Task ShowAsync(ObjectiveDto objective)
    {
        objectiveToScan = objective;
        scanMessage = null;
        isScanError = false;
        IsOpen = true;
        _isScannerComponentActive = true;
        await InvokeAsync(StateHasChanged);
        await Task.Yield(); // Laisser le temps au rendu HTML
        
        if (qrScannerRef != null)
        {
            await qrScannerRef.StartAsync();
        }
        else 
        {
             Console.WriteLine("ERREUR: qrScannerRef est null après le rendu !");
        }
    }

    public void Show(ObjectiveDto objective) => _ = ShowAsync(objective);

    public async void Close()
    {
        if (qrScannerRef != null) try { await qrScannerRef.StopAsync(); } catch { }
        IsOpen = false;
        objectiveToScan = null;
        StateHasChanged();
    }

    private async Task HandleScanResult(string qrCode)
    {
        if (objectiveToScan == null) return;

        // 1. Pause visuelle
        _isScannerComponentActive = false;
        scanMessage = "Analyse en cours...";
        await InvokeAsync(StateHasChanged);
        qrScannerRef = null;

        // 2. Appel API
        try
        {
            var request = new CreateValidationDto 
            { 
                Type = "Objective",
                QrCode = objectiveToScan.Id.ToString(),
                UserQrCode = qrCode 
            };

            var response = await Http.PostAsJsonAsync("api/dashboard/process-scan", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ValidationResponseDto>();
                
                // --- FIX : AFFICHAGE DU GAIN (Issue 3) ---
                scanMessage = $"✅ {result?.Message} !";
                if (result != null) 
                {
                    scanMessage += $" Gagnez : +{result.RewardXp} XP / +{result.RewardCurrency} Coins.";
                    // Notification au Dashboard de rafraîchir les stats du joueur
                    await OnScanSuccessRefresh.InvokeAsync(); 
                }
                isScanError = false;
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                scanMessage = $"❌ ERREUR VALIDATION : {errorMsg.Trim('\"')}";
                isScanError = true;
            }
        }
        catch (Exception ex)
        {
            scanMessage = "Erreur technique : " + ex.Message;
            isScanError = true;
        }

        // 3. Affichage résultat
        await InvokeAsync(StateHasChanged);
        
        // --- FIX : DÉLAI RÉDUIT (Issue 2) ---
        await Task.Delay(800); 

        // 4. Relance
        if (IsOpen)
        {
            scanMessage = null;
            _isScannerComponentActive = true;
            await InvokeAsync(StateHasChanged);
            await Task.Yield();
            if (qrScannerRef != null) await qrScannerRef.StartAsync();
        }
    }
}