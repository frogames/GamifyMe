@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div id="@scannerId" style="width:100%; max-width:500px; border:1px solid #ddd;">

 <p style="text-align: center; color: var(--text-muted-color); padding:1rem;">
 Veuillez autoriser l'accès à la caméra
 </p>

</div>

@code {
 //2. Un ID unique pour le 'div'
 private string scannerId = $"qr-scanner-{Guid.NewGuid()}";

 //3. Une référence à cet objet .NET pour que JS puisse nous appeler
 private DotNetObjectReference<QrCodeScanner>? dotnetObjectReference;

 // Protection / état
 private bool started = false;
 private bool disposed = false;

 //4. L'événement qui renvoie le texte du QR code au parent
 [Parameter]
 public EventCallback<string> OnScanSuccess { get; set; }

 //5. Démarrer le scanner après l'affichage du composant
 protected override async Task OnAfterRenderAsync(bool firstRender)
 {
 await base.OnAfterRenderAsync(firstRender);

 if (firstRender && !started && !disposed)
 {
 try
 {
 // Prépare l'objet .NET pour que JS puisse l'appeler
 dotnetObjectReference = DotNetObjectReference.Create(this);

 // Appelle la fonction "start" de notre fichier qrScanner.js
 // On encadre l'appel pour éviter qu'une erreur JS ne fasse planter l'UI
 await JSRuntime.InvokeVoidAsync("qrScanner.start", scannerId, dotnetObjectReference);
 started = true;
 Console.WriteLine($"QrCodeScanner: démarré (elementId={scannerId}).");
 }
 catch (JSException jsEx)
 {
 // Erreur côté JS : on logge et on nève pas le composant
 Console.WriteLine($"QrCodeScanner JS error: {jsEx.Message}");
 started = false;
 }
 catch (Exception ex)
 {
 Console.WriteLine($"QrCodeScanner erreur inattendue: {ex.Message}");
 started = false;
 }
 }
 }

 //6. MÉTHODE APPELÉE PAR JAVASCRIPT
 [JSInvokable]
 public async Task HandleScanResult(string decodedText)
 {
 // Le JS a trouvé un code ! On remonte l'événement au parent.
 try
 {
 await OnScanSuccess.InvokeAsync(decodedText);
 }
 catch (Exception ex)
 {
 Console.WriteLine($"QrCodeScanner.HandleScanResult error: {ex.Message}");
 }
 }

 //7. Arrêter la caméra quand le composant est détruit
 public async ValueTask DisposeAsync()
 {
 if (disposed) return;
 disposed = true;

 try
 {
 if (started)
 {
 try
 {
 await JSRuntime.InvokeVoidAsync("qrScanner.stop", scannerId);
 Console.WriteLine($"QrCodeScanner: stop demandé (elementId={scannerId}).");
 }
 catch (JSException jsEx)
 {
 Console.WriteLine($"QrCodeScanner stop JS error: {jsEx.Message}");
 }
 catch (Exception ex)
 {
 Console.WriteLine($"QrCodeScanner stop unexpected error: {ex.Message}");
 }
 }
 }
 finally
 {
 dotnetObjectReference?.Dispose();
 dotnetObjectReference = null;
 started = false;
 }
 }
}